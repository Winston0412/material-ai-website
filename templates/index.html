<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¬ Material Science AI Assistant - DeepSeek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .message-fade { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">
                <i class="fas fa-microscope text-blue-600"></i>
                Material Science AI Assistant
            </h1>
            <p class="text-xl text-gray-600">åŸºäº DeepSeek çš„æ™ºèƒ½ææ–™ç§‘å­¦åˆ†æåŠ©æ‰‹</p>
            <div class="flex justify-center gap-4 mt-4 text-sm">
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">
                    <i class="fas fa-check-circle"></i> DeepSeek AI
                </span>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                    <i class="fab fa-github"></i> GitHubåˆ†æ
                </span>
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
                    <i class="fas fa-file-alt"></i> æ–‡æ¡£å¤„ç†
                </span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
            <!-- AIèŠå¤©åŒºåŸŸ -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-robot text-blue-500 mr-3"></i>
                    DeepSeek ææ–™ç§‘å­¦åŠ©æ‰‹
                </h2>
                
                <div id="chat-container" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg space-y-4">
                    <div class="message-fade text-center text-gray-500">
                        <i class="fas fa-comments text-2xl mb-2"></i>
                        <p>æ¬¢è¿ï¼æˆ‘æ˜¯åŸºäº DeepSeek çš„ææ–™ç§‘å­¦åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”å„ç§ææ–™ç§‘å­¦é—®é¢˜ã€‚</p>
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="question-input" 
                           placeholder="è¾“å…¥ææ–™ç§‘å­¦é—®é¢˜ï¼Œå¦‚ï¼šä»€ä¹ˆæ˜¯å½¢çŠ¶è®°å¿†åˆé‡‘ï¼Ÿ"
                           class="flex-1 border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="sendQuestion()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="setExample('ä»€ä¹ˆæ˜¯å½¢çŠ¶è®°å¿†åˆé‡‘ï¼Ÿ')" 
                            class="text-left text-sm text-blue-600 hover:text-blue-800 p-2 bg-blue-50 rounded-lg">
                        <i class="fas fa-lightbulb mr-1"></i>å½¢çŠ¶è®°å¿†åˆé‡‘
                    </button>
                    <button onclick="setExample('é«˜åˆ†å­ææ–™çš„åŠ›å­¦æ€§èƒ½å¦‚ä½•æµ‹è¯•ï¼Ÿ')" 
                            class="text-left text-sm text-blue-600 hover:text-blue-800 p-2 bg-blue-50 rounded-lg">
                        <i class="fas fa-lightbulb mr-1"></i>åŠ›å­¦æ€§èƒ½æµ‹è¯•
                    </button>
                </div>
            </div>

            <!-- GitHubåˆ†æåŒºåŸŸ -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fab fa-github text-gray-800 mr-3"></i>
                    GitHubææ–™ä»“åº“åˆ†æ
                </h2>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="repo-input" 
                           placeholder="è¾“å…¥GitHubä»“åº“URLï¼Œå¦‚ï¼šhttps://github.com/materialsproject/materialsproject"
                           class="flex-1 border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="analyzeRepo()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                        <i class="fas fa-chart-bar"></i>
                    </button>
                </div>

                <div id="github-result" class="h-80 overflow-y-auto p-4 bg-gray-50 rounded-lg">
                    <div class="text-center text-gray-500">
                        <i class="fab fa-github text-2xl mb-2"></i>
                        <p>è¾“å…¥GitHubä»“åº“URLåˆ†æææ–™ç§‘å­¦é¡¹ç›®</p>
                    </div>
                </div>
            </div>

            <!-- æ–‡æ¡£å¤„ç†åŒºåŸŸ -->
            <div class="bg-white rounded-2xl shadow-xl p-6 lg:col-span-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-file-alt text-purple-500 mr-3"></i>
                    ææ–™ç§‘å­¦æ–‡æ¡£å¤„ç†
                </h2>

                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center mb-4">
                    <input type="file" id="file-input" 
                           accept=".pdf,.docx,.txt,.md"
                           class="hidden">
                    <div class="space-y-4">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                        <p class="text-gray-600">ä¸Šä¼ ææ–™ç§‘å­¦æ–‡æ¡£ (PDF, Word, TXT, MD)</p>
                        <button onclick="document.getElementById('file-input').click()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors">
                            <i class="fas fa-upload mr-2"></i>é€‰æ‹©æ–‡ä»¶
                        </button>
                    </div>
                </div>

                <div id="file-info" class="hidden mb-4 p-4 bg-blue-50 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span id="file-name" class="font-semibold"></span>
                        <button onclick="clearFile()" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="processDocument()" 
                            class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-semibold transition-colors">
                        <i class="fas fa-cogs mr-2"></i>åˆ†ææ–‡æ¡£
                    </button>
                </div>

                <div id="document-result" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                    <!-- æ–‡æ¡£åˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="mt-8 text-center space-y-2">
            <div id="system-status" class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow">
                <i class="fas fa-circle text-green-500"></i>
                <span class="text-sm text-gray-600">ç³»ç»Ÿæ­£å¸¸è¿è¡Œ</span>
            </div>
            <div id="deepseek-status" class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow">
                <i class="fas fa-brain text-yellow-500"></i>
                <span class="text-sm text-gray-600">æ£€æŸ¥ DeepSeek çŠ¶æ€...</span>
            </div>
        </div>
    </div>

    <script>
        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                document.getElementById('system-status').innerHTML = `
                    <i class="fas fa-circle text-green-500"></i>
                    <span class="text-sm text-gray-600">${data.service} - æ­£å¸¸è¿è¡Œ</span>
                `;
            } catch (error) {
                document.getElementById('system-status').innerHTML = `
                    <i class="fas fa-circle text-red-500"></i>
                    <span class="text-sm text-gray-600">ç³»ç»Ÿè¿æ¥å¤±è´¥</span>
                `;
            }
        }

        // æ£€æŸ¥DeepSeekçŠ¶æ€
        async function checkDeepSeekStatus() {
            try {
                const response = await fetch('/api/deepseek/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('deepseek-status');
                if (statusElement) {
                    if (data.status === 'connected') {
                        statusElement.innerHTML = `
                            <i class="fas fa-brain text-green-500"></i>
                            <span class="text-sm text-gray-600">DeepSeek AI å·²è¿æ¥</span>
                        `;
                    } else {
                        statusElement.innerHTML = `
                            <i class="fas fa-brain text-red-500"></i>
                            <span class="text-sm text-gray-600">DeepSeek AI æœªè¿æ¥</span>
                        `;
                    }
                }
            } catch (error) {
                console.error('DeepSeekçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // AIèŠå¤©åŠŸèƒ½
        async function sendQuestion() {
            const question = document.getElementById('question-input').value.trim();
            if (!question) return;

            const chatContainer = document.getElementById('chat-container');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = document.createElement('div');
            userMessage.className = 'message-fade flex justify-end';
            userMessage.innerHTML = `
                <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none px-4 py-2 max-w-xs">
                    <div class="font-semibold">æ‚¨</div>
                    <div>${question}</div>
                </div>
            `;
            chatContainer.appendChild(userMessage);

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('question-input').value = '';

            // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message-fade flex justify-start';
            loadingMessage.innerHTML = `
                <div class="bg-gray-200 rounded-2xl rounded-tl-none px-4 py-2">
                    <div class="flex items-center gap-2">
                        <div class="loading w-2 h-2 bg-gray-600 rounded-full"></div>
                        <div class="loading w-2 h-2 bg-gray-600 rounded-full"></div>
                        <div class="loading w-2 h-2 bg-gray-600 rounded-full"></div>
                        <span class="text-sm text-gray-600">DeepSeek AI æ€è€ƒä¸­...</span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question})
                });
                
                const data = await response.json();
                
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                chatContainer.removeChild(loadingMessage);

                // æ·»åŠ AIå›å¤
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message-fade flex justify-start';
                aiMessage.innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-none px-4 py-2 max-w-2xl">
                        <div class="font-semibold text-blue-600 flex items-center gap-2">
                            <i class="fas fa-brain text-green-500"></i>
                            DeepSeek AI
                        </div>
                        <div class="whitespace-pre-wrap mt-2">${data.answer}</div>
                        <div class="mt-2 text-xs text-gray-500">
                            <i class="fas fa-database"></i> æ¥æº: ${data.sources.join(', ')}
                        </div>
                    </div>
                `;
                chatContainer.appendChild(aiMessage);
                chatContainer.scrollTop = chatContainer.scrollHeight;

            } catch (error) {
                chatContainer.removeChild(loadingMessage);
                alert('å‘é€é—®é¢˜å¤±è´¥: ' + error.message);
            }
        }

        // GitHubåˆ†æåŠŸèƒ½
        async function analyzeRepo() {
            const repoUrl = document.getElementById('repo-input').value.trim();
            if (!repoUrl) return;

            const resultContainer = document.getElementById('github-result');
            resultContainer.innerHTML = `
                <div class="flex justify-center items-center h-16">
                    <div class="loading text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>åˆ†æä»“åº“ä¸­...
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/github/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({repo_url: repoUrl})
                });
                
                const data = await response.json();
                
                if (data.analysis.error) {
                    resultContainer.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">åˆ†æå¤±è´¥</div>
                            <div class="text-red-600">${data.analysis.error}</div>
                        </div>
                    `;
                } else {
                    const analysis = data.analysis;
                    resultContainer.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h3 class="font-semibold text-green-800 mb-2">${analysis.repo_info.name}</h3>
                                <p class="text-green-700">${analysis.repo_info.description || 'æ— æè¿°'}</p>
                                <a href="${analysis.repo_info.url}" target="_blank" class="text-blue-600 hover:underline text-sm">
                                    <i class="fab fa-github"></i> è®¿é—®ä»“åº“
                                </a>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center p-3 bg-blue-50 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${analysis.repo_info.stars}</div>
                                    <div class="text-sm text-blue-800">Stars</div>
                                </div>
                                <div class="text-center p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${analysis.repo_info.forks}</div>
                                    <div class="text-sm text-green-800">Forks</div>
                                </div>
                                <div class="text-center p-3 bg-purple-50 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600">${analysis.repo_info.language || 'N/A'}</div>
                                    <div class="text-sm text-purple-800">è¯­è¨€</div>
                                </div>
                                <div class="text-center p-3 bg-orange-50 rounded-lg">
                                    <div class="text-2xl font-bold text-orange-600">${analysis.material_analysis.is_material_related ? 'âœ…' : 'âŒ'}</div>
                                    <div class="text-sm text-orange-800">ææ–™ç›¸å…³</div>
                                </div>
                            </div>
                            
                            ${analysis.material_analysis.material_files.length > 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-800 mb-2">ææ–™ç›¸å…³æ–‡ä»¶</h4>
                                <div class="text-sm text-yellow-700">
                                    ${analysis.material_analysis.material_files.map(file => `<div>â€¢ ${file}</div>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                resultContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-red-800 font-semibold">è¯·æ±‚å¤±è´¥</div>
                        <div class="text-red-600">${error.message}</div>
                    </div>
                `;
            }
        }

        // æ–‡æ¡£å¤„ç†åŠŸèƒ½
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('file-info');
                const fileName = document.getElementById('file-name');
                
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
            }
        });

        function clearFile() {
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').classList.add('hidden');
        }

        async function processDocument() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const resultContainer = document.getElementById('document-result');
            resultContainer.innerHTML = `
                <div class="flex justify-center items-center h-16">
                    <div class="loading text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>å¤„ç†æ–‡æ¡£ä¸­...
                    </div>
                </div>
            `;
            resultContainer.classList.remove('hidden');

            try {
                const response = await fetch('/api/documents/process', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.analysis.error) {
                    resultContainer.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-red-800 font-semibold">å¤„ç†å¤±è´¥</div>
                            <div class="text-red-600">${data.analysis.error}</div>
                        </div>
                    `;
                } else {
                    const analysis = data.analysis;
                    resultContainer.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h3 class="font-semibold text-green-800 mb-2">æ–‡æ¡£åˆ†æå®Œæˆ</h3>
                                <p class="text-green-700">æˆåŠŸå¤„ç†æ–‡æ¡£: ${data.filename}</p>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="text-center p-3 bg-blue-50 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600">${analysis.length}</div>
                                    <div class="text-sm text-blue-800">å­—ç¬¦æ•°</div>
                                </div>
                                <div class="text-center p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${analysis.categories.length}</div>
                                    <div class="text-sm text-green-800">ææ–™ç±»åˆ«</div>
                                </div>
                                <div class="text-center p-3 bg-purple-50 rounded-lg">
                                    <div class="text-2xl font-bold text-purple-600">${Object.keys(analysis.keyword_density).length}</div>
                                    <div class="text-sm text-purple-800">å…³é”®è¯ç±»å‹</div>
                                </div>
                            </div>
                            
                            ${analysis.categories.length > 0 ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-800 mb-2">è¯†åˆ«åˆ°çš„ææ–™ç±»åˆ«</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${analysis.categories.map(cat => `
                                        <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">
                                            ${cat}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">å†…å®¹æ‘˜è¦</h4>
                                <p class="text-gray-700 text-sm">${analysis.summary}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="text-red-800 font-semibold">å¤„ç†å¤±è´¥</div>
                        <div class="text-red-600">${error.message}</div>
                    </div>
                `;
            }
        }

        // å·¥å…·å‡½æ•°
        function setExample(question) {
            document.getElementById('question-input').value = question;
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('question-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestion();
            }
        });

        // åˆå§‹åŒ–
        checkSystemStatus();
        checkDeepSeekStatus();
        setInterval(checkSystemStatus, 30000);
        setInterval(checkDeepSeekStatus, 45000);
    </script>
</body>
</html>
